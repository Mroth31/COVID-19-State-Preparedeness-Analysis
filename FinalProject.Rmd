---
title: "FinalProject"
author: "Ajay Karatam and Michael Rothschilds"
date: "5/13/2020"
output: html_document
---
## An Analysis of U.S Hospital Bed Capacity During the COVID-19 Pandemic
by Michael Rothschilds and Ajay Karatam

## Introduction: 
The COVID-19 pandemic has altered the lives of millions over the past few months. 
People have practiced Social Distancing at an unprecedented level with the intention 
of keeping people safe and "flattening the curve". The purpose of "flattening the curve" 
is to prevent hospitals from being overun with too many COVID-19 patients at once. 
In order to stop this from happening, public health and government officials need to 
project the number of cases, the rate of hospitilization, and the resulting number of 
hospital and ICU beds needed at any given time across all areas of the United States. 
The following data was collected from a team of researchers at the Harvard Global Data Institute. 
They made projections for different infection rates and used surveys conducted by 
The American Hospital Association to predict the true availability of hospital and ICU beds.

## Examine the original dataset here: 
https://www.kaggle.com/mrmorj/hospital-bed-capacity-and-covid19

## R Libraries Used
``` {r libraries}
library(tidyverse)
library(lubridate)
library(dplyr)
library(broom)
library(leaflet)
```



## Dataframe Setup and Tidying
We begin our setup by downloading the dataset into our local directory and opening here as .csv file. Some columns that required separation were split using regex like the ones seen below. This process also included re-arranging as well as omitting some columns for the sake of readability. Furthermore, we added two more columns that served as a mathematical computation of two other columns. The final tidy dataframe is setup as "df" which is what we will be using later on in the analysis. 
```{r setup}
csv_file <- "HRR_Scorecard.csv"
hcb <- read_csv(csv_file)

#delete the first entry since it contains garbage values
hcb = hcb[-1,]
df <- hcb %>%
  #choose the relevant columns that we want to work with from hcb 
  select(1:12)
df
#extract the state as a separate column from HRR
df$State <- str_extract(df$HRR, "([A-Z]{2})")

#extract the town as a separate column from HRR
df$Town <- sub(", [A-Z]{2}$", "", df$HRR)

#re-arrange the columns to make the data more presentable
df <- df[c(14,13,2,4,5,3,6,7,8,9,10,11,12)]

#calculate the percentage of occupied hospital beds
df$calc_hospital = ((df[c(4)] / df[c(3)])*100)
df$`Occupied Hospital Beds percentage` <- round(df$calc_hospital$`Available Hospital Beds`,digits=2) 

#calculate the percent of occupied ICU beds
df$calc_ICU = ((df[c(7)] / df[c(6)])*100)
df$`Occupied ICU Beds percentage` <- round(df$calc_ICU$`Available ICU Beds`, digits=2)

#final columns re-arrangement
df <- df[c(1,2,3,4,5,15,6,7,8,17,9,10,11,12,13)]
head(df)
```


## Data Analysis
Given that our data deals with a statistical analysis of the hospital beds and ICU beds availability as well as population age distribtion across the top 300 US hospital markets; we decided to split out analysis into 3 parts to offer a detailed story.

## Part1: Hospital and ICU Dataframe Setup
Most of the attributes for the Hospital and ICU are very similar ex: 'Hospital Beds Availble', 'ICU Beds Available' or 
'Total Hospital Beds', 'Total ICU beds'. It made sense to pull the relevant attributes from the tidy dataframe (df) and used it in our analysis for the Hospital and ICU. 
In the process of setting up this new dataframe, we decided to combine the regions for every state as one entry, we achieved this by adding up all the attributes ex: 'Total Hospital Beds', 'Total ICU Beds'. That way we end up with a more interpretable dataframe of 51 entries and 10 columns. Combining the attributes helps us generalize the analysis to each state rather than every region and this was what we were aiming to do with this project to begin with.
The final two columns that I added were the rate of hospital beds availablity and rate of icu beds availability, both of these attributes help us in understanding how each state's hospital and icu ward compare with one another.  

```{r analysis setup hospital and icu}

beds_df <- df %>%
  select(1:10)%>%
  group_by(State)%>%
  summarize(`No. of Regions` = n_distinct(Town),
            `Total Hospital Beds` = sum(`Total Hospital Beds`), 
            `Hospital Beds Available` = sum(`Available Hospital Beds`),
            `Potential Hospital Beds Available` = sum(`Potentially Available Hospital Beds*`),
            `Total ICU Beds` = sum(`Total ICU Beds`), 
            `ICU Beds Available` = sum(`Available ICU Beds`),
            `Potential ICU Beds Available` = sum(`Potentially Available ICU Beds*`)
            )%>%
  mutate(`Rate of Hospital beds availability` = (`Hospital Beds Available`/`Total Hospital Beds`)*100)%>%
  mutate(`Rate of ICU beds availability` = (`ICU Beds Available`/`Total ICU Beds`)*100)%>%
  select(1,2,3,4,5,9,6,7,8,10)%>%
  arrange(State)
beds_df
beds_df$`Rate of Hospital beds availability` = round(beds_df$`Rate of Hospital beds availability`, digits=2)
beds_df$`Rate of ICU beds availability` = round(beds_df$`Rate of ICU beds availability`, digits=2)
```


## Part 2: Hospital Analysis
Plot 1: Scatter plot of Hospital Beds Occupied vs Available
  To interprete this graph, we know that Hospital Beds Available <= Total Beds Available as a universal truth, therefore, a point which is higher on the y-axis is an indication that there are more beds available. Additionally, the closer the x axis is to 0 and a higher y axis point means that the hospital is operating extremely efficiently.
From this plot, there seems be more concentration of points around x <= 20,000 and y <= 5,000; this means that roughly 25% hospital beds are available for most of these states. Ofcourse there are a few states which have more total beds but a higher ratio of occupied beds (>25%).

Plot 2: Bargraph of the Top 10 States with the Lowest Rate of Hospital Beds Availability
  The states included in this graph gives the reader an understanding of the population demographics for these regions, it is easy to guess that there could be a significant older adult population. Also the number of regions for each of these states is another indicator of the intensity of beds occupancy. From the graph, New York has the most hospitals as well as the least availability, Rhode Island also has fewer hospitals and a tad lower availability rate. An interesting feature about the states in this list is the fact that most of them belong in the East coast.

Plot 3: Linear Regression Model of Hospital: Potential Available Beds vs Available Beds
  This regression plot features a unique attribute which is "Potential Available Beds", this attribute was part of our original dataset and it is a numerical value that represents the scenrario if non-covid patients took up 50% less beds. By plotting this against the current available beds, the regression analysis will help us understand the correlation. Off the bat, it seems like the concentration lies around lower x and y values. The stright linear regression curve is a strong indication that many hospitals can promise 50% more hospital beds.

```{r plot analysis hospital}
  hosp_df <- beds_df %>%
    select(1:6)%>%
    group_by(State, `No. of Regions`)%>%
    arrange(`Rate of Hospital beds availability`)
  hosp_df
  
  ggplot(hosp_df, mapping=aes(x=`Total Hospital Beds`, y=`Hospital Beds Available`))+
    geom_point(mapping=aes(color = State))+
    ggtitle("Scatter plot of Hospital Beds Occupied vs Available")
  
  hosp_df[1:10,] %>%
    ggplot(mapping=aes(x=State, y=`Rate of Hospital beds availability`, fill= `No. of Regions`))+
    geom_col(mapping=aes())+
    ggtitle("Top 10 States with the Lowest Rate of Hospital Beds Availability")
  
  ggplot(hosp_df, mapping=aes(x=`Potential Hospital Beds Available`, y=`Hospital Beds Available`))+
    geom_point(mapping=aes(color = State))+
    geom_smooth(method=lm)+
    ggtitle("Linear Regression Model of Hospital: Potential Available Beds vs Available Beds")
```

## Part 3: ICU Analysis
Plot 1: Scatter plot of ICU Beds Occupied vs Available
  ICU beds occupancy is an interesting factor to observe simply because of its dependent nature, in other words, ICU beds occupancy is dependant on demographic factors like number of old people or number of hospitals in a given state. From the graph below, similar to the results from the Hospital beds version of this graph, has a lower concentration at lower x and y values. From color inspection is seems like most states are maintaining similar hospital beds and icu beds availability rate. The states within the concetration seem to show that roughy 50% of the icu beds are available. States with more hospital beds show lower availability rate (~30%).

Plot 2: Bargraph of the Top 10 States with the Lowest Rate of ICU Beds Availability
This plot just like the hospital plot version, compares the top 10 lowest ICU beds availability rates with respect to region. From observations, Nevada has the lowest availability rate while also having the least number of regions, Florida on the other hand has roughly 8% higher availability rate and significantly more regions.
It is interesting to find that Georgia, Rhode Island, Nevada, Hawaii, North Carolina; all of which were featured in both hospital and ice bargraphs; this is an indication of hospital inefficiency in these regions as well higher demand.

Plot 3: Linear Regression Model of ICU: Potential Available Beds vs Available Beds
As discussed earlier in the hospital plot, the potential available beds attribute introduces an efficient method to increase hospital beds occupancy for covid patients. Interestingly enough, the linear regression is similar to the one we observed earlier, this means that most hospitals can promise 50% more ICU beds for most states in the concentraion. However, unlike hospital beds, ICU beds can be optimized to offer 50% more even for hospitals with 4000 or more beds. This is a nod to the 1:2 ratio nature of the relation.


```{r plot analysis icu}
  icu_df <- beds_df %>%
    select(1,2,7,8,9,10)%>%
    group_by(State, `No. of Regions`)%>%
    arrange(`Rate of ICU beds availability`)
  icu_df
  
  ggplot(icu_df, mapping=aes(x=`Total ICU Beds`, y=`ICU Beds Available`))+
    geom_point(mapping=aes(color = State))+
    ggtitle("Scatter plot of ICU Beds Occupied vs Available")
  
  icu_df[1:10,] %>%
    ggplot(mapping=aes(x=State, y=`Rate of ICU beds availability`, fill= `No. of Regions`))+
    geom_col(mapping=aes())+
    ggtitle("Top 10 States with the Lowest Rate of ICU Beds Availability")
  
  ggplot(icu_df, mapping=aes(x=`Potential ICU Beds Available`, y=`ICU Beds Available`))+
    geom_point(mapping=aes(color = State))+
    geom_smooth(method=lm)+
    ggtitle("Linear Regression Model of ICU: Potential Available Beds vs Available Beds")
  
```




## Population Data Frame:
Create a data frame focusing on the estimated COVID-19 General Population Data. 
Take the Region data and turn it into statewide data. 
Once we have statewide data, we multiply the Projected infections, hospitalizations, 
and ICU admittances by 3 to represent a doomsday scenario where 60 percent of adults 
get the virus rather than 20 percent in the original data frame. 
This represents a 200 percent increase in projected cases but is a plausible scenario.
Create a Scatter Plot showing which states have the highest percentage of elderly adults as 
part of their adult population.

``` {r popdataframe}
pop_df <- df %>% select(Town, State, `Adult Population`, `Population 65+`, 
`Projected Infected Individuals`, `Projected Hospitalized Individuals`, 
`Projected Individuals Needing ICU Care`)

states_pop_df <- pop_df %>% 
  group_by(State) %>%
  summarize(Adult_Population = sum(`Adult Population`), 
  `Population 65+` = sum(`Population 65+`), 
  Projected_Infected_Individuals = sum(`Projected Infected Individuals`), 
  Projected_Hospitalized_Individuals = sum(`Projected Hospitalized Individuals`), 
  Projected_ICU_Care = sum(`Projected Individuals Needing ICU Care`))

states_pop_df <- states_pop_df %>%
  mutate(DoomsDay_Projected_Infected_Individuals = Projected_Infected_Individuals * 3, 
  Doomsday_Projected_Hospitalized_Individuals = Projected_Hospitalized_Individuals *3, 
  Doomsday_Projected_ICU_Care = Projected_ICU_Care * 3)


states_pop_df %>%
  mutate(Percentage_Adults_Older_65 = (`Population 65+` / Adult_Population) * 100) %>%
  ggplot(mapping=aes(x=Percentage_Adults_Older_65, y= Adult_Population, color = State))+
  geom_point()+
  labs(title = "Percentage of Adults Older than 65 In Each State", x="Percentage", 
  y="Number of Adults")
  
```


```{r merge}
  merge_df <- merge(beds_df, states_pop_df, by="State")
```


=======
## Doomsday Plot:
I would like to depict the differences in projected hospitilizations in the 
doomsday scenario for each state.

``` {r doomsdayplot}
states_pop_df %>%
  mutate(difference_in_hospitilzations = 
  Doomsday_Projected_Hospitalized_Individuals - Projected_Hospitalized_Individuals) %>%
  ggplot(mapping=aes(x = difference_in_hospitilzations, y= Adult_Population, color= State))+
  geom_point()+
  labs(title = "Difference in Projected Hospitilizations in Each State", 
  x="Difference", y="Number of Adults")
  
  
```  

## Top 10 States Most at Risk Based on the sum of Total Adult Population / Projected Hospitilizations and Elderly Population / Adult Population 

``` {r mostatriskstates}
states_pop_df <- states_pop_df %>% 
  mutate(Risk_Level = (Projected_Hospitalized_Individuals + `Population 65+`) / Adult_Population) %>%
  arrange(desc(Risk_Level))

select(states_pop_df, State, Risk_Level)
```


## Calculating Risk Factor to predict the risk factor in each state. The 4 dependent variables will be rate of hospital availability, rate of ICU bed availability, Percentage adult population that is 65+, and avg of projected infected and projected_doomsday infected.Then

``` {r calculatingriskfactor}

merge_df <- merge_df %>% 
  mutate(Preparedness_Score = ((`Population 65+`/Adult_Population)*.3 +
                          ((`Rate of Hospital beds availability`/100) + 
                          (`Rate of ICU beds availability`/100)) *.70)*100)

fit_df <- select(merge_df, State, `Rate of Hospital beds availability`, 
`Rate of ICU beds availability`, Adult_Population, `Population 65+`, Preparedness_Score)

fit_df <- fit_df %>%
  mutate(Percentage_65_older = (`Population 65+` / Adult_Population) * 30, 
  Hospital_Bed_Availability = ((`Rate of Hospital beds availability`/100) + 
  (`Rate of ICU beds availability`/100))*70)


lm_df <- glm(Preparedness_Score ~ Percentage_65_older + Hospital_Bed_Availability, data=fit_df)
broom::tidy(lm_df)
lm_df%>%
  tidy()%>%
  knitr::kable(digits=4)


ggplot(lm_df, mapping=aes(x=lm_df$fitted.values, y=lm_df$residuals))+
    geom_point(mapping=aes(color = lm_df$data$State))+
    geom_smooth(method=lm)+
    labs(title="Linear Regression model of Residuals over fitted values",
        y = "Residuals",
         x = "Fitted Values",
        color = "State")

# Reached 120 lines of code

fit_df$fitted_values <- lm_df$fitted.values

```



## Map Analysis of the State Preparedness Score
In order to assess each state's preparedness score with respect to one another, we decided to utilize the leaflet library. We started off by downloading a csv file with the latitudes for each state and then merged it with our data to create a new data frame (map_df). Using the preparedness score for each state, we color coded them in order to show visually which states could be at risk. As the preparedness score ranges roughly from 40-95, with 40 being considered least prepared, the color sequence follows that range as well with Red indicating a state is poorly equipped where as blue is an indication of strongly equipped state.

```{r map}
#https://www.kaggle.com/washimahmed/usa-latlong-for-state-abbreviations
csv_file <- "statelatlong.csv"
sll <- read_csv(csv_file)

map_df <- merge(sll, fit_df, by = "State")

map_df$Preparedness_Score = round(map_df$Preparedness_Score, digits = 2)
map_df$Preparedness_Score = as.character(map_df$Preparedness_Score)
map_df$Preparedness_Score = paste("Preparedness Score = ", map_df$Preparedness_Score)


pal <- colorFactor(c("red", "orange", "yellow", "green", "blue"), domain = c(map_df$fitted_values))

prep_map <- leaflet(map_df) %>%
  addTiles() %>%
  #Longitude and Latitude of Kansas was used as the default map co-ordinates.
  setView(lat=38.49, lng=-98.32, zoom=4) %>%
  addCircleMarkers(radius = ~map_df$fitted_values/2.2, popup = map_df$Preparedness_Score,
                   color = ~pal(map_df$fitted_values), fillOpacity = 0.8)

prep_map
```