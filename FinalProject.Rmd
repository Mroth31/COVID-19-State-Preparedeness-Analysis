---
title: "FinalProject"
author: "Ajay Karatam and Michael Rothschilds"
date: "5/13/2020"
output: html_document
---
## An Analysis of U.S Hospital Bed Capacity During the COVID-19 Pandemic
by Michael Rothschilds and Ajay Karatam

## Introduction: 
The COVID-19 pandemic has altered the lives of millions over the past few months. 
People have practiced Social Distancing at an unprecedented level with the intention 
of keeping people safe and "flattening the curve". The purpose of "flattening the curve" 
is to prevent hospitals from being overun with too many COVID-19 patients at once. 
In order to stop this from happening, public health and government officials need to 
project the number of cases, the rate of hospitilization, and the resulting number of 
hospital and ICU beds needed at any given time across all areas of the United States. 
The following data was collected from a team of researchers at the Harvard Global Data Institute. 
They made projections for different infection rates and used surveys conducted by 
The American Hospital Association to predict the true availability of hospital and ICU beds.

## Examine the original dataset here: 
https://www.kaggle.com/mrmorj/hospital-bed-capacity-and-covid19

## R Libraries Used
``` {r libraries}
library(tidyverse)
library(lubridate)
library(dplyr)
library(broom)
```



## Dataframe Setup and Tidying

```{r setup}
csv_file <- "HRR_Scorecard.csv"
hcb <- read_csv(csv_file)

#delete the first entry since it contains garbage values
hcb = hcb[-1,]
df <- hcb %>%
  #choose the relevant columns that we want to work with from hcb 
  select(1:12)
df
#extract the state as a separate column from HRR
df$State <- str_extract(df$HRR, "([A-Z]{2})")

#extract the town as a separate column from HRR
df$Town <- sub(", [A-Z]{2}$", "", df$HRR)

#re-arrange the columns to make the data more presentable
df <- df[c(14,13,2,4,5,3,6,7,8,9,10,11,12)]

#calculate the percentage of occupied hospital beds
df$calc_hospital = ((df[c(4)] / df[c(3)])*100)
df$`Occupied Hospital Beds percentage` <- round(df$calc_hospital$`Available Hospital Beds`,digits=2) 

#calculate the percent of occupied ICU beds
df$calc_ICU = ((df[c(7)] / df[c(6)])*100)
df$`Occupied ICU Beds percentage` <- round(df$calc_ICU$`Available ICU Beds`, digits=2)

#final columns re-arrangement
df <- df[c(1,2,3,4,5,15,6,7,8,17,9,10,11,12,13)]
head(df)
```

## Data Analysis
```{r analysis setup hospital and icu}

beds_df <- df %>%
  select(1:10)%>%
  group_by(State)%>%
  summarize(`No. of Regions` = n_distinct(Town),
            `Total Hospital Beds` = sum(`Total Hospital Beds`), 
            `Hospital Beds Available` = sum(`Available Hospital Beds`),
            `Potential Hospital Beds Available` = sum(`Potentially Available Hospital Beds*`),
            `Total ICU Beds` = sum(`Total ICU Beds`), 
            `ICU Beds Available` = sum(`Available ICU Beds`),
            `Potential ICU Beds Available` = sum(`Potentially Available ICU Beds*`)
            )%>%
  mutate(`Rate of Hospital beds availability` = (`Hospital Beds Available`/`Total Hospital Beds`)*100)%>%
  mutate(`Rate of ICU beds availability` = (`ICU Beds Available`/`Total ICU Beds`)*100)%>%
  select(1,2,3,4,5,9,6,7,8,10)%>%
  arrange(State)
beds_df
beds_df$`Rate of Hospital beds availability` = round(beds_df$`Rate of Hospital beds availability`, digits=2)
beds_df$`Rate of ICU beds availability` = round(beds_df$`Rate of ICU beds availability`, digits=2)
```

```{r plot analysis hospital}
  hosp_df <- beds_df %>%
    select(1:6)%>%
    group_by(State, `No. of Regions`)%>%
    arrange(`Rate of Hospital beds availability`)
  hosp_df
  
  ggplot(hosp_df, mapping=aes(x=`Total Hospital Beds`, y=`Hospital Beds Available`))+
    geom_point(mapping=aes(color = State))+
    ggtitle("Scatter plot of Hospital Beds Occupied vs Available")
  
  hosp_df[1:10,] %>%
    ggplot(mapping=aes(x=State, y=`Rate of Hospital beds availability`, fill= `No. of Regions`))+
    geom_col(mapping=aes())+
    ggtitle("Top 10 States with the Lowest Rate of Hospital Beds Availability")
  
  ggplot(hosp_df, mapping=aes(x=`Potential Hospital Beds Available`, y=`Hospital Beds Available`))+
    geom_point(mapping=aes(color = State))+
    geom_smooth(method=lm)+
    ggtitle("Linear Regression Model of Hospital: Potential Available Beds vs Available Beds")
  
  
```




```{r plot analysis icu}
  icu_df <- beds_df %>%
    select(1,2,7,8,9,10)%>%
    group_by(State, `No. of Regions`)%>%
    arrange(`Rate of ICU beds availability`)
  icu_df
  
  ggplot(icu_df, mapping=aes(x=`Total ICU Beds`, y=`ICU Beds Available`))+
    geom_point(mapping=aes(color = State))+
    ggtitle("Scatter plot of ICU Beds Occupied vs Available")
  
  icu_df[1:10,] %>%
    ggplot(mapping=aes(x=State, y=`Rate of ICU beds availability`, fill= `No. of Regions`))+
    geom_col(mapping=aes())+
    ggtitle("Top 10 States with the Lowest Rate of ICU Beds Availability")
  
  ggplot(icu_df, mapping=aes(x=`Potential ICU Beds Available`, y=`ICU Beds Available`))+
    geom_point(mapping=aes(color = State))+
    geom_smooth(method=lm)+
    ggtitle("Linear Regression Model of ICU: Potential Available Beds vs Available Beds")
  
```




## Population Data Frame:
Create a data frame focusing on the estimated COVID-19 General Population Data. 
Take the Region data and turn it into statewide data. 
Once we have statewide data, we multiply the Projected infections, hospitalizations, 
and ICU admittances by 3 to represent a doomsday scenario where 60 percent of adults 
get the virus rather than 20 percent in the original data frame. 
This represents a 200 percent increase in projected cases but is a plausible scenario.
Create a Scatter Plot showing which states have the highest percentage of elderly adults as 
part of their adult population.

``` {r popdataframe}
pop_df <- df %>% select(Town, State, `Adult Population`, `Population 65+`, 
`Projected Infected Individuals`, `Projected Hospitalized Individuals`, 
`Projected Individuals Needing ICU Care`)

states_pop_df <- pop_df %>% 
  group_by(State) %>%
  summarize(Adult_Population = sum(`Adult Population`), 
  `Population 65+` = sum(`Population 65+`), 
  Projected_Infected_Individuals = sum(`Projected Infected Individuals`), 
  Projected_Hospitalized_Individuals = sum(`Projected Hospitalized Individuals`), 
  Projected_ICU_Care = sum(`Projected Individuals Needing ICU Care`))

states_pop_df <- states_pop_df %>%
  mutate(DoomsDay_Projected_Infected_Individuals = Projected_Infected_Individuals * 3, 
  Doomsday_Projected_Hospitalized_Individuals = Projected_Hospitalized_Individuals *3, 
  Doomsday_Projected_ICU_Care = Projected_ICU_Care * 3)


states_pop_df %>%
  mutate(Percentage_Adults_Older_65 = (`Population 65+` / Adult_Population) * 100) %>%
  ggplot(mapping=aes(x=Percentage_Adults_Older_65, y= Adult_Population, color = State))+
  geom_point()+
  labs(title = "Percentage of Adults Older than 65 In Each State", x="Percentage", 
  y="Number of Adults")
  
```


```{r merge}
  merge_df <- merge(beds_df, states_pop_df, by="State")
```


=======
## Doomsday Plot:
I would like to depict the differences in projected hospitilizations in the 
doomsday scenario for each state.

``` {r doomsdayplot}
states_pop_df %>%
  mutate(difference_in_hospitilzations = 
  Doomsday_Projected_Hospitalized_Individuals - Projected_Hospitalized_Individuals) %>%
  ggplot(mapping=aes(x = difference_in_hospitilzations, y= Adult_Population, color= State))+
  geom_point()+
  labs(title = "Difference in Projected Hospitilizations in Each State", 
  x="Difference", y="Number of Adults")
  
  
```  

## Top 10 States Most at Risk Based on the sum of Total Adult Population / Projected Hospitilizations and Elderly Population / Adult Population 

``` {r mostatriskstates}
states_pop_df <- states_pop_df %>% 
  mutate(Risk_Level = (Projected_Hospitalized_Individuals + `Population 65+`) / Adult_Population) %>%
  arrange(desc(Risk_Level))

select(states_pop_df, State, Risk_Level)
```


## Calculating Risk Factor to predict the risk factor in each state. The 4 dependent variables will be rate of hospital availability, rate of ICU bed availability, Percentage adult population that is 65+, and avg of projected infected and projected_doomsday infected.Then

``` {r calculatingriskfactor}

merge_df <- merge_df %>% 
  mutate(Preparedness_Score = ((`Population 65+`/Adult_Population)*.3 +
                          ((`Rate of Hospital beds availability`/100) + 
                          (`Rate of ICU beds availability`/100)) *.70)*100)

lm_df <- merge_df %>%
    select(1, 2, 6, 10, 13, 16, 19)%>%
    arrange(merge_df$Preparedness_Score)
lm_df

fit_df <- select(merge_df, State, `Rate of Hospital beds availability`, 
`Rate of ICU beds availability`, Adult_Population, `Population 65+`, Preparedness_Score)

fit_df <- fit_df %>%
  mutate(Percentage_65_older = (`Population 65+` / Adult_Population) * 30, 
  Hospital_Bed_Availability = ((`Rate of Hospital beds availability`/100) + 
  (`Rate of ICU beds availability`/100))*70)


lm_df <- glm(Preparedness_Score ~ Percentage_65_older + Hospital_Bed_Availability, data=fit_df)
broom::tidy(lm_df)
lm_df%>%
  tidy()%>%
  knitr::kable(digits=4)


ggplot(lm_df, mapping=aes(x=lm_df$residuals , y=lm_df$fitted.values))+
    geom_point(mapping=aes(color = lm_df$data$State))+
    geom_smooth(method=lm)+
    labs(title="Linear Regression model of Residuals over fitted values",
        x = "Fitted values",
         y = "Residuals",
        color = "State")

# Reached 124 lines of code
```

