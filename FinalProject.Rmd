---
title: "FinalProject"
author: "Ajay Karatam and Michael Rothschilds"
date: "5/13/2020"
output: html_document
---
## An Analysis of U.S Hospital Bed Capacity During the COVID-19 Pandemic
by Michael Rothschilds and Ajay Karatam

## Introduction: 
The COVID-19 pandemic has altered the lives of millions over the past few months. 
People have practiced Social Distancing at an unprecedented level with the intention 
of keeping people safe and "flattening the curve". The purpose of "flattening the curve" 
is to prevent hospitals from being overun with too many COVID-19 patients at once. 
In order to stop this from happening, public health and government officials need to 
project the number of cases, the rate of hospitilization, and the resulting number of 
hospital and ICU beds needed at any given time across all areas of the United States. 
The following data was collected from a team of researchers at the Harvard Global Data Institute. 
They made projections for different infection rates and used surveys conducted by 
The American Hospital Association to predict the true availability of hospital and ICU beds.

## Examine the original dataset here: 
https://www.kaggle.com/mrmorj/hospital-bed-capacity-and-covid19

## R Libraries Used
``` {r libraries}
library(tidyverse)
library(lubridate)
library(dplyr)
library(broom)
library(leaflet)
```



## Part 1 Dataframe Setup and Tidying

```{r setup}
csv_file <- "HRR_Scorecard.csv"
hcb <- read_csv(csv_file)

#delete the first entry since it contains garbage values
hcb = hcb[-1,]
df <- hcb %>%
  #choose the relevant columns that we want to work with from hcb 
  select(1:12)
df
#extract the state as a separate column from HRR
df$State <- str_extract(df$HRR, "([A-Z]{2})")

#extract the town as a separate column from HRR
df$Town <- sub(", [A-Z]{2}$", "", df$HRR)

#re-arrange the columns to make the data more presentable
df <- df[c(14,13,2,4,5,3,6,7,8,9,10,11,12)]

#calculate the percentage of occupied hospital beds
df$calc_hospital = ((df[c(4)] / df[c(3)])*100)
df$`Occupied Hospital Beds percentage` <- round(df$calc_hospital$`Available Hospital Beds`,digits=2) 

#calculate the percent of occupied ICU beds
df$calc_ICU = ((df[c(7)] / df[c(6)])*100)
df$`Occupied ICU Beds percentage` <- round(df$calc_ICU$`Available ICU Beds`, digits=2)

#final columns re-arrangement
df <- df[c(1,2,3,4,5,15,6,7,8,17,9,10,11,12,13)]
head(df)
```

## Part 2 Data Analysis With a Focus on Hospital and ICU Bed Capacity
```{r analysis setup hospital and icu}

beds_df <- df %>%
  select(1:10)%>%
  group_by(State)%>%
  summarize(`No. of Regions` = n_distinct(Town),
            `Total Hospital Beds` = sum(`Total Hospital Beds`), 
            `Hospital Beds Available` = sum(`Available Hospital Beds`),
            `Potential Hospital Beds Available` = sum(`Potentially Available Hospital Beds*`),
            `Total ICU Beds` = sum(`Total ICU Beds`), 
            `ICU Beds Available` = sum(`Available ICU Beds`),
            `Potential ICU Beds Available` = sum(`Potentially Available ICU Beds*`)
            )%>%
  mutate(`Rate of Hospital beds availability` = (`Hospital Beds Available`/`Total Hospital Beds`)*100)%>%
  mutate(`Rate of ICU beds availability` = (`ICU Beds Available`/`Total ICU Beds`)*100)%>%
  select(1,2,3,4,5,9,6,7,8,10)%>%
  arrange(State)
beds_df
beds_df$`Rate of Hospital beds availability` = round(beds_df$`Rate of Hospital beds availability`, digits=2)
beds_df$`Rate of ICU beds availability` = round(beds_df$`Rate of ICU beds availability`, digits=2)
```

```{r plot analysis hospital}
  hosp_df <- beds_df %>%
    select(1:6)%>%
    group_by(State, `No. of Regions`)%>%
    arrange(`Rate of Hospital beds availability`)
  hosp_df
  
  ggplot(hosp_df, mapping=aes(x=`Total Hospital Beds`, y=`Hospital Beds Available`))+
    geom_point(mapping=aes(color = State))+
    ggtitle("Scatter plot of Hospital Beds Occupied vs Available")
  
  hosp_df[1:10,] %>%
    ggplot(mapping=aes(x=State, y=`Rate of Hospital beds availability`, fill= `No. of Regions`))+
    geom_col(mapping=aes())+
    ggtitle("Top 10 States with the Lowest Rate of Hospital Beds Availability")
  
  ggplot(hosp_df, mapping=aes(x=`Potential Hospital Beds Available`, y=`Hospital Beds Available`))+
    geom_point(mapping=aes(color = State))+
    geom_smooth(method=lm)+
    ggtitle("Linear Regression Model of Hospital: Potential Available Beds vs Available Beds")
  
  
```




```{r plot analysis icu}
  icu_df <- beds_df %>%
    select(1,2,7,8,9,10)%>%
    group_by(State, `No. of Regions`)%>%
    arrange(`Rate of ICU beds availability`)
  icu_df
  
  ggplot(icu_df, mapping=aes(x=`Total ICU Beds`, y=`ICU Beds Available`))+
    geom_point(mapping=aes(color = State))+
    ggtitle("Scatter plot of ICU Beds Occupied vs Available")
  
  icu_df[1:10,] %>%
    ggplot(mapping=aes(x=State, y=`Rate of ICU beds availability`, fill= `No. of Regions`))+
    geom_col(mapping=aes())+
    ggtitle("Top 10 States with the Lowest Rate of ICU Beds Availability")
  
  ggplot(icu_df, mapping=aes(x=`Potential ICU Beds Available`, y=`ICU Beds Available`))+
    geom_point(mapping=aes(color = State))+
    geom_smooth(method=lm)+
    ggtitle("Linear Regression Model of ICU: Potential Available Beds vs Available Beds")
  
```




## Part 4: Data Analysis with a Focus on State Population and Projected Infection Rates
The purpose of this section is to take the entire dataset and use it to create a smaller 
dataset that focuses on the population.

## Step 1: 
Obtain this smaller dataset that includes Town, State, Adult 
Population, Population 65+, Projected Infected Individual, 
Projected Hospitalized Individuals, and Projected Individuals Needing ICU Care. 

``` {r step1}
pop_df <- df %>% select(Town, State, `Adult Population`, `Population 65+`, 
`Projected Infected Individuals`, `Projected Hospitalized Individuals`, 
`Projected Individuals Needing ICU Care`)
```

## Step 2:
Turn the region data into statewide data by grouping by state and using summarize to 
add the totals for each state. The statewide data allows the opportunity to compare the 
risks that states are facing based on total population. The dataset contains all of the 
large regional hospitals, so we felt that the transition to statewide data would be seamless. 

``` {r step2}
states_pop_df <- pop_df %>% 
  group_by(State) %>%
  summarize(Adult_Population = sum(`Adult Population`), 
  `Population 65+` = sum(`Population 65+`), 
  Projected_Infected_Individuals = sum(`Projected Infected Individuals`), 
  Projected_Hospitalized_Individuals = sum(`Projected Hospitalized Individuals`), 
  Projected_ICU_Care = sum(`Projected Individuals Needing ICU Care`))
```

## Step 3:
Once statewide data exists, we next wanted to show how much the risk would increase if 60 percent 
of the adult population contracted the virus in each state. In order to provide a snapshot, we 
tripled the number of Projected Infected Individuals, Projected Hospitalized Individuals, and 
Projected Individuals Needing ICU Care. This represents a 200 percent increase in each category 
over the original twenty percent. This is a plausible estimate according to various projection models.

``` {r step3}

states_pop_df <- states_pop_df %>%
  mutate(DoomsDay_Projected_Infected_Individuals = Projected_Infected_Individuals * 3, 
  Doomsday_Projected_Hospitalized_Individuals = Projected_Hospitalized_Individuals *3, 
  Doomsday_Projected_ICU_Care = Projected_ICU_Care * 3)

```
## Step 4: 
After doing this, we created a scatterplot showing the difference in the number of hospitalizations
with the exact same adult population to emphasize how much worse this plausible scenario could make 
the situation. This scatterplot highlighted the risks that higher population states face if they arenâ€™t 
properly equipped. 

``` {r step4}
states_pop_df %>%
  mutate(difference_in_hospitilzations = 
  Doomsday_Projected_Hospitalized_Individuals - Projected_Hospitalized_Individuals) %>%
  ggplot(mapping=aes(x = difference_in_hospitilzations, y= Adult_Population, color= State))+
  geom_point()+
  labs(title = "Difference in Projected Hospitilizations in Each State", 
  x="Difference", y="Number of Adults")
  
  
``` 

## Step 5: 
When focusing solely on population, one of the most important things to consider is the proportion 
of people who are older than 65. It is well known that this demographic is at highest risk for this 
virus as they are much more likely to be hospitalized when they contract the virus. In order to depict 
this across the fifty states, we created a scatterplot with the adult population mapped to the y-axis 
and the percentage of adults older than 65 on the x axis for each state.  

``` {r step5}
states_pop_df %>%
  mutate(Percentage_Adults_Older_65 = (`Population 65+` / Adult_Population) * 100) %>%
  ggplot(mapping=aes(x=Percentage_Adults_Older_65, y= Adult_Population, color = State))+
  geom_point()+
  labs(title = "Percentage of Adults Older than 65 In Each State", x="Percentage", 
  y="Number of Adults")
  
```
## Step 6:
Furthermore, we used the proportion of adult population and the projected number of hospitalizations 
to calculate a risk level by state just according to the population. The purpose of this is to depict how 
a more frequent older population puts a state at risk. When you combine that with questionable hospital 
supplies, a state can be in major trouble.  

``` {r step6}
states_pop_df <- states_pop_df %>% 
  mutate(Risk_Level = (Projected_Hospitalized_Individuals + `Population 65+`) / Adult_Population) %>%
  arrange(desc(Risk_Level))

select(states_pop_df, State, Risk_Level)
```

## Part 5: Merging the Two Data Frames To Calculate a Preparedness Score

## Step 1: 
We merged the beds data frame from parts 2 and 3 with the population data frame from part 4.

```{r merge}
  merge_df <- merge(beds_df, states_pop_df, by="State")
```


## Step 2: 

In order to quantify which states were the most prepared and which states were the least prepared, 
we used the merged dataset to calculate a preparedness score. In order to calculate the score, we 
derived a formula that uses the percentage of population 65 and older, the rate of hospital bed 
availability, and the rate of ICU bed availability. We felt that these factors differentiated the states 
the most and concluded that the rate of available hospital and ICU beds was more than twice as important 
as the percentage of elderly population in a state. This formula produced a score on a scale of 0 to 100
and is represented by the continuous attribute "preparedness_score". The states who were the most prepared 
had scores in the 65-90 range, while the states who were the least prepared had scores in the 43-55 range. 

``` {r step2}

merge_df <- merge_df %>% 
  mutate(Preparedness_Score = ((`Population 65+`/Adult_Population)*.3 +
                          ((`Rate of Hospital beds availability`/100) + 
                          (`Rate of ICU beds availability`/100)) *.70)*100)

merge_df
```

## Step 3: 
Once we calculated our preparedness_score, we created a separate data frame to prepare for Logistic Regression.
This data frame includes all of the pertinent variables in our regression model, including the building blocks 
for the calculation of each preparedness_score.

``` {r step3}

fit_df <- select(merge_df, State, `Rate of Hospital beds availability`, 
`Rate of ICU beds availability`, Adult_Population, `Population 65+`, Preparedness_Score)

fit_df <- fit_df %>%
  mutate(Percentage_65_older = (`Population 65+` / Adult_Population) * 30, 
  Hospital_Bed_Availability = ((`Rate of Hospital beds availability`/100) + 
  (`Rate of ICU beds availability`/100))*70)

```
## Step 4:
We perform logistic regression using the fit_df created in step 3. The purpose of doing this is to
quantify the relationship between preparedness_scores and the two independent variables. The 
preparedness score is the dependent variable whilethe Percentage_65_older and the Hospital_Bed_Availability 
are the independent variables. Using the broom library, the tidy function with our model produces a p value 
of 0.25, which tells us that our relationship is relatively strong, but not strong enough to be statistically 
significant.

``` {r step4}
lm_df <- glm(Preparedness_Score ~ Percentage_65_older + Hospital_Bed_Availability, data=fit_df)
broom::tidy(lm_df)
lm_df%>%
  tidy()%>%
  knitr::kable(digits=4)

```

## Step 5:
We used the results of the logistic regression to graph the residuals versus the fitted values. Our residuals 
appear to skew a little below zero, but they are within a reasonable range of zero.

``` {r step5}

ggplot(lm_df, mapping=aes(x=lm_df$residuals , y=lm_df$fitted.values))+
    geom_point(mapping=aes(color = lm_df$data$State))+
    geom_smooth(method=lm)+
    labs(title="Linear Regression model of Residuals over fitted values",
        x = "Residuals",
         y = "Fitted Values",
        color = "State")

# Reached 120 lines of code

fit_df$fitted_values <- lm_df$fitted.values

```

## Part 6: Visually Depicting the Tiers of Preparedness_Score

```{r map}
#https://www.kaggle.com/washimahmed/usa-latlong-for-state-abbreviations
csv_file <- "statelatlong.csv"
sll <- read_csv(csv_file)

map_df <- merge(sll, fit_df, by = "State")

map_df$Preparedness_Score = round(map_df$Preparedness_Score, digits = 2)
map_df$Preparedness_Score = as.character(map_df$Preparedness_Score)
map_df$Preparedness_Score = paste("Preparedness Score = ", map_df$Preparedness_Score)


pal <- colorFactor(c("red", "orange", "yellow", "green", "blue"), domain = c(map_df$fitted_values))

prep_map <- leaflet(map_df) %>%
  addTiles() %>%
  setView(lat=39.29, lng=-76.61, zoom=4) %>%
  addCircleMarkers(radius = ~map_df$fitted_values/2.2, popup = map_df$Preparedness_Score,
                   color = ~pal(map_df$fitted_values), fillOpacity = 0.8)

prep_map


```
```



